<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Huh!</title>
<link rel="shortcut icon" href="ghost.png"/>
<style>

html, body
{
	margin: 0; padding: 0;
	background: #000;
	overflow: hidden;
}

canvas,
#Message
{
	position: fixed;
	left: 0; top: 0;
	right: 0; bottom: 0;
}

#Message
{
	z-index: 1;
	padding: 1em;
	font: 16pt monospace; color: #fff;
	font-weight: bolder;
	text-align: center;
	line-height: 150%;
}

</style>
</head>
<body>
<div id="Message">Loading ...</div>
<script>

"use strict";

Math.TAU = Math.TAU || Math.PI+Math.PI;

var message,
	canvas,
	ctx,
	width,
	height,
	gameOver = false,
	enemiesLength = 100,
	enemies = [],
	enemy = new Image(),
	playerX = .5,
	playerY = .5,
	player = new Image(),
	start;

function drawSprite( sprite, x, y )
{
	ctx.drawImage(
		sprite,
		(x-8) | 0,
		(y-8) | 0 );
}

function drawEnemies()
{
	for( var n = enemiesLength; n--; )
	{
		var e = enemies[n],
			dx = playerX-e.x,
			dy = playerY-e.y,
			d = Math.sqrt( dx*dx + dy*dy ),
			r = (1-d)*.01;

		if( d < .01 )
			gameOver = true;

		if( d < .2 )
		{
			var f = e.speed/d;

			e.vx = dx*f;
			e.vy = dy*f;

			if( e.speed < .002 )
				e.speed += .00001;
		}

		e.x += e.vx;
		e.y += e.vy;

		if( e.x < 0 || e.x > 1 )
			e.vx = -e.vx;

		if( e.y < 0 || e.y > 1 )
			e.vy = -e.vy;

		drawSprite(
			enemy,
			e.x*width,
			e.y*height );
	}
}

function drawPlayer()
{
	drawSprite(
		player,
		playerX*width,
		playerY*height );
}

function run()
{
	ctx.clearRect( 0, 0, width, height );

	drawEnemies();
	drawPlayer();

	if( gameOver )
	{
		message.innerHTML = "You survived "+
			((new Date().getTime()-start)/1000 | 0)+" seconds!";

		message.style.display = "block";

		return;
	}

	requestAnimationFrame( run );
}

function pointerUp( ev )
{
	var e = (ev || event);

	if( gameOver )
	{
		reset();
		gameOver = false;
		message.style.display = "none";
		run();

		e.preventDefault();
		return false;
	}

	if( "clientX" in e )
	{
		playerX = e.clientX;
		playerY = e.clientY;
	}
	else if( "pageX" in e )
	{
		playerX = e.pageX;
		playerY = e.pageY;
	}

	playerX /= width;
	playerY /= height;

	e.preventDefault();
	return false;
}

function resize()
{
	width = window.innerWidth;
	height = window.innerHeight;

	canvas.width = width;
	canvas.height = height;
	canvas.style.width = width+"px";
	canvas.style.height = height+"px";
}

function reset()
{
	for( var n = enemiesLength; n--; )
	{
		var a = Math.random()*Math.TAU,
			va = Math.random()*Math.TAU,
			r = .1+Math.random()*.4,
			s = .0005;

		enemies[n] = {
			x: .5+Math.cos( a )*r,
			y: .5+Math.sin( a )*r,
			vx: Math.cos( va )*s,
			vy: Math.sin( va )*s,
			speed: s };
	}

	playerX = .5;
	playerY = .5;

	start = new Date().getTime();
}

function init()
{
	var d = document;

	if( !(message = d.getElementById( "Message" )) ||
		!(canvas = d.createElement( "canvas" )) ||
		!(ctx = canvas.getContext( "2d" )) )
		return;

	enemy.src = "priest.png";
	player.src = "ghost.png";

	window.onresize = resize;
	resize();

	function waitThenRun()
	{
		if( !enemy.complete ||
			!player.complete )
		{
			setTimeout( waitThenRun, 500 );
			return;
		}

		message.style.display = "none";

		d.onmouseup = pointerUp;

		if( "ontouchend" in d )
			d.ontouchend = pointerUp;

		d.body.appendChild( canvas );

		reset();
		run();
	}

	waitThenRun();
}

window.onload = init;

</script>
</body>
</html>
