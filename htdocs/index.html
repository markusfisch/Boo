<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="msapplication-tap-highlight" content="no"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Boo</title>
<link rel="shortcut icon" href="icon.png"/>
<link rel="apple-touch-icon-precomposed" href="icon.png"/>
<style>

html,
body
{
	margin: 0; padding: 0;
	background: #111;
	overflow: hidden;
	-ms-touch-action: none;
}

canvas
{
	position: fixed;
	left: 0; top: 0;
}

</style>
<head>
<body>
<script>

"use strict";

Math.TAU = Math.TAU || Math.PI*2;

var requestAnimFrame =
		window.requestAnimationFrame ||
		window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		function( callback )
		{
			window.setTimeout( callback, 16 );
		},
	resources = {
		0: { rect: {/*0*/x:244,y:37,w:3,h:6} },
		1: { rect: {/*1*/x:228,y:20,w:2,h:6} },
		2: { rect: {/*2*/x:244,y:31,w:3,h:6} },
		3: { rect: {/*3*/x:244,y:24,w:3,h:6} },
		4: { rect: {/*4*/x:244,y:18,w:3,h:6} },
		5: { rect: {/*5*/x:244,y:12,w:3,h:6} },
		6: { rect: {/*6*/x:244,y:6,w:3,h:6} },
		7: { rect: {/*7*/x:244,y:0,w:3,h:6} },
		8: { rect: {/*8*/x:241,y:37,w:3,h:6} },
		9: { rect: {/*9*/x:241,y:31,w:3,h:6} },
		a: { rect: {/*a*/x:241,y:24,w:3,h:6} },
		b: { rect: {/*b*/x:241,y:18,w:3,h:6} },
		c: { rect: {/*c*/x:241,y:12,w:3,h:6} },
		d: { rect: {/*d*/x:241,y:6,w:3,h:6} },
		e: { rect: {/*e*/x:241,y:0,w:3,h:6} },
		f: { rect: {/*f*/x:238,y:37,w:3,h:6} },
		g: { rect: {/*g*/x:238,y:31,w:3,h:6} },
		h: { rect: {/*h*/x:238,y:24,w:3,h:6} },
		i: { rect: {/*i*/x:238,y:18,w:3,h:6} },
		j: { rect: {/*j*/x:228,y:14,w:2,h:6} },
		k: { rect: {/*k*/x:238,y:12,w:3,h:6} },
		l: { rect: {/*l*/x:238,y:6,w:3,h:6} },
		m: { rect: {/*m*/x:230,y:12,w:5,h:6} },
		n: { rect: {/*n*/x:234,y:31,w:4,h:6} },
		o: { rect: {/*o*/x:238,y:0,w:3,h:6} },
		p: { rect: {/*p*/x:234,y:37,w:3,h:6} },
		q: { rect: {/*q*/x:230,y:24,w:4,h:6} },
		r: { rect: {/*r*/x:235,y:18,w:3,h:6} },
		s: { rect: {/*s*/x:235,y:12,w:3,h:6} },
		t: { rect: {/*t*/x:235,y:6,w:3,h:6} },
		u: { rect: {/*u*/x:235,y:0,w:3,h:6} },
		v: { rect: {/*v*/x:230,y:6,w:5,h:6} },
		w: { rect: {/*w*/x:230,y:0,w:5,h:6} },
		x: { rect: {/*x*/x:229,y:37,w:5,h:6} },
		y: { rect: {/*y*/x:229,y:31,w:5,h:6} },
		z: { rect: {/*z*/x:230,y:18,w:4,h:6} },
		".": { rect: {/*point*/x:234,y:28,w:1,h:2} },
		":": { rect: {/*colon*/x:234,y:24,w:1,h:4} },
		",": { rect: {/*comma*/x:228,y:26,w:1,h:3} },
		"!": { rect: {/*exclamation*/x:234,y:18,w:1,h:6} },
		"?": { rect: {/*question*/x:235,y:24,w:3,h:6} },
		ground: { rect: {/*ground*/x:144,y:31,w:16,h:16} },
		yardTopLeft: { rect: {/*yard-top-left*/x:32,y:31,w:16,h:16} },
		yardTop: { rect: {/*yard-top*/x:0,y:30,w:16,h:16} },
		yardTopRight: { rect: {/*yard-top-right*/x:16,y:31,w:16,h:16} },
		yardLeft: { rect: {/*yard-left*/x:80,y:31,w:16,h:16} },
		yardMiddle: { rect: {/*yard-middle*/x:64,y:31,w:16,h:16} },
		yardRight: { rect: {/*yard-right*/x:48,y:31,w:16,h:16} },
		yardBottomLeft: { rect: {/*yard-bottom-left*/x:128,y:31,w:16,h:16} },
		yardBottom: { rect: {/*yard-bottom*/x:96,y:31,w:16,h:16} },
		yardBottomRight: { rect: {/*yard-bottom-right*/x:112,y:31,w:16,h:16} },
		grave0: { rect: {/*grave0*/x:31,y:0,w:15,h:31} },
		grave1: { rect: {/*grave1*/x:94,y:0,w:16,h:29} },
		grave2: { rect: {/*grave2*/x:0,y:0,w:16,h:30} },
		grave3: { rect: {/*grave3*/x:173,y:0,w:15,h:28} },
		grave4: { rect: {/*grave4*/x:142,y:0,w:15,h:29} },
		grave5: { rect: {/*grave5*/x:157,y:0,w:16,h:27} },
		grave6: { rect: {/*grave6*/x:62,y:0,w:16,h:29} },
		grave7: { rect: {/*grave7*/x:126,y:0,w:16,h:28} },
		grave8: { rect: {/*grave8*/x:46,y:0,w:16,h:29} },
		grave9: { rect: {/*grave9*/x:110,y:0,w:16,h:28} },
		grave10: { rect: {/*grave10*/x:16,y:0,w:15,h:31} },
		grave11: { rect: {/*grave11*/x:78,y:0,w:16,h:29} },
		ghost0: { rect: {/*ghost0*/x:160,y:31,w:12,h:16} },
		ghost1: { rect: {/*ghost1*/x:196,y:31,w:10,h:16} },
		ghost2: { rect: {/*ghost2*/x:206,y:31,w:9,h:16} },
		ghost3: { rect: {/*ghost3*/x:188,y:15,w:11,h:16} },
		ghost4: { rect: {/*ghost2*/x:206,y:31,w:9,h:16} },
		ghost5: { rect: {/*ghost1*/x:196,y:31,w:10,h:16} },
		priestCrow0: { rect: {/*priest-crow0*/x:188,y:0,w:12,h:15} },
		priestCrow1: { rect: {/*priest-crow1*/x:184,y:31,w:12,h:15} },
		priestCrow2: { rect: {/*priest-crow2*/x:172,y:31,w:12,h:15} },
		priestCrow3: { rect: {/*priest-crow1*/x:184,y:31,w:12,h:15} },
		priestWalkRight0: { rect: {/*priest-walk0*/x:200,y:16,w:9,h:15} },
		priestWalkRight1: { rect: {/*priest-walk1*/x:209,y:0,w:11,h:14} },
		priestWalkRight2: { rect: {/*priest-walk2*/x:220,y:14,w:8,h:15} },
		priestWalkRight3: { rect: {/*priest-walk3*/x:215,y:31,w:8,h:16} },
		priestWalkRight4: { rect: {/*priest-walk4*/x:209,y:14,w:10,h:15} },
		priestWalkRight5: { rect: {/*priest-walk5*/x:220,y:0,w:10,h:14} },
		priestWalkRight6: { rect: {/*priest-walk6*/x:223,y:31,w:6,h:15} },
		priestWalkRight7: { rect: {/*priest-walk7*/x:200,y:0,w:9,h:16} },
		priestWalkLeft0: { rect: {/*priest-walk0*/x:200,y:16,w:9,h:15},
			mirror: true },
		priestWalkLeft1: { rect: {/*priest-walk1*/x:209,y:0,w:11,h:14},
			mirror: true },
		priestWalkLeft2: { rect: {/*priest-walk2*/x:220,y:14,w:8,h:15},
			mirror: true },
		priestWalkLeft3: { rect: {/*priest-walk3*/x:215,y:31,w:8,h:16},
			mirror: true },
		priestWalkLeft4: { rect: {/*priest-walk4*/x:209,y:14,w:10,h:15},
			mirror: true },
		priestWalkLeft5: { rect: {/*priest-walk5*/x:220,y:0,w:10,h:14},
			mirror: true },
		priestWalkLeft6: { rect: {/*priest-walk6*/x:223,y:31,w:6,h:15},
			mirror: true },
		priestWalkLeft7: { rect: {/*priest-walk7*/x:200,y:0,w:9,h:16},
			mirror: true },
	},
	atlas,
	atlasWidth,
	resizeTimer,
	resizing,
	bg,
	ctxBg,
	fg,
	ctxFg,
	hud,
	ctxHud,
	hudX,
	hudY,
	message,
	ctxMessage,
	messageWidth,
	ratio,
	width,
	height,
	centerX,
	centerY,
	scaleFactor,
	mapLeft,
	mapTop,
	mapRight,
	mapBottom,
	sprites = {},
	running,
	now,
	last,
	factor,
	audioChannelsLength = 4,
	audioChannels = [],
	sounds = {},
	pointerLength = 0,
	pointerX = [],
	pointerY = [],
	gameOver,
	frameFrequency = 100,
	seed,
	priestsLength,
	priests = [],
	radiusSeen,
	radiusCastOut,
	radiusCollision,
	playerX,
	playerY,
	playerFrame,
	playerFrameLast,
	playerAlive,
	scores,
	scoreLast,
	fragmentsLength,
	fragments = [];

function drawText( ctx, text, x, y )
{
	for( var n = 0, l = text.length; n < l; ++n )
	{
		var ch = text.substr( n, 1 );

		if( ch == " " )
		{
			x += scaleFactor << 2;
			continue;
		}

		var sprite = sprites[ch];

		ctx && ctx.drawImage(
			sprite,
			x | 0,
			(y-sprite.height) | 0 );

		x += scaleFactor+sprite.width;
	}

	return x;
}

function putText( ctx, text )
{
	var y = sprites.a.height;

	ctx.clearRect( 0, 0, width, y );
	drawText( ctx, text, 0, y );
}

function drawSprite( sprite, x, y )
{
	ctxFg.drawImage(
		sprite,
		(x-sprite.centerX) | 0,
		(y-sprite.centerY) | 0 );
}

function drawFragments()
{
	var pixel = Math.ceil( scaleFactor );

	for( var n = fragmentsLength; n--; )
	{
		var f = fragments[n];

		if( f.x < 0 ||
			f.x > width ||
			f.y < 0 ||
			f.y > height )
			continue;

		f.x += f.vx*factor;
		f.y += f.vy*factor;
		f.spin += factor*.06;
		++f.live;

		var a = 1.005;
		f.vx *= a;
		f.vy *= a;

		var sin = Math.sin( f.spin )*scaleFactor*2;

		ctxFg.fillStyle = f.color;
		ctxFg.fillRect(
			(f.x+sin*f.vy) | 0,
			(f.y-sin*f.vx) | 0,
			pixel,
			pixel );
	}
}

function drawPlayer()
{
	var state = "ghost";

	if( now-playerFrameLast > frameFrequency )
	{
		++playerFrame;
		playerFrame %= 6;
		playerFrameLast = now;
	}

	ctxFg.globalAlpha = pointerLength ? 1 : .3;
	drawSprite(
		sprites[state+playerFrame],
		playerX,
		playerY+Math.sin( now*.002 )*scaleFactor );
	ctxFg.globalAlpha = 1;
}

function bounce( value, change, min, max )
{
	var l = max-min,
		r;

	if( (r = value-min) < change )
		value = min-(r % l);
	else if( (r = value-max) > change )
		value = max-(r % l);

	return value;
}

function setFragments()
{
	for( var n = fragmentsLength; n--; )
	{
		var f = fragments[n],
			speed = 1+Math.random()*scaleFactor;

		f.x = playerX+f.ox*scaleFactor;
		f.y = playerY+f.oy*scaleFactor;
		f.vx = f.ovx*speed;
		f.vy = f.ovy*speed;
		f.live = 0;
	}
}

function notifyPriests()
{
	for( var n = priestsLength; n--; )
	{
		var p = priests[n],
			dx = p.x-playerX,
			dy = p.y-playerY,
			d = Math.sqrt( dx*dx + dy*dy );

		p.crow = now+Math.random()*(d/scaleFactor)*10;
	}
}

function killPlayer()
{
	playerAlive = false;
	setFragments();
	notifyPriests();

	setTimeout(
		function()
		{
			gameOver = true;

			var t = "try again!";
			messageWidth = drawText( null, t, 0, 0 );
			putText( ctxMessage, t );
		},
		1500 );
}

function drawPriestCrowing( p )
{
	if( now-p.lastFrame > frameFrequency )
	{
		++p.frame;
		p.frame %= 4;
		p.lastFrame = now;
	}

	drawSprite(
		sprites["priestCrow"+(p.frame % 4)],
		p.x,
		p.y );
}

function drawPriestWalking( p )
{
	for( var n = 0; n < priestsLength; ++n )
	{
		var other = priests[n];

		if( other === p )
			continue;

		var dx = other.x-p.x,
			dy = other.y-p.y,
			d = dx*dx + dy*dy;

		if( d < radiusCollision )
		{
			p.x += -dx;
			p.y += -dy;
			p.vx = -p.vx;
			p.vy = -p.vy;
		}
	}

	var state = "priestWalk"+(p.vx > 0 ? "Right" : "Left");

	p.x += p.vx*factor;
	p.y += p.vy*factor;

	if( p.x < mapLeft ||
		p.x > mapRight )
	{
		p.x = bounce( p.x, p.vx, mapLeft, mapRight );
		p.vx = -p.vx;
	}

	if( p.y < mapTop ||
		p.y > mapBottom )
	{
		p.y = bounce( p.y, p.vy, mapTop, mapBottom );
		p.vy = -p.vy;
	}

	var dx = playerX-p.x,
		dy = playerY-p.y,
		d = dx*dx + dy*dy;

	if( d < radiusSeen )
	{
		if( playerAlive &&
			(d = Math.sqrt( d )) < radiusCastOut )
			killPlayer();

		if( pointerLength )
		{
			d /= scaleFactor;
			p.vx = dx/d;
			p.vy = dy/d;
		}
	}

	if( now-p.lastFrame > frameFrequency )
	{
		++p.frame;
		p.frame %= 8;
		p.lastFrame = now;
	}

	drawSprite(
		sprites[state+p.frame],
		p.x,
		p.y );
}

function compareY( a, b )
{
	if( a.y > b.y )
		return 1;

	if( a.y < b.y )
		return -1;

	return 0;
}

function drawPriests()
{
	priests.sort( compareY );

	for( var n = 0; n < priestsLength; ++n )
	{
		var p = priests[n];

		if( p.crow < now )
			drawPriestCrowing( p );
		else
			drawPriestWalking( p );
	}
}

function draw()
{
	if( resizing )
		return;

	ctxFg.clearRect( 0, 0, width, height );

	drawPriests();

	if( playerAlive )
		drawPlayer();
	else
	{
		drawFragments();

		if( gameOver )
			ctxFg.drawImage(
				message,
				centerX-(messageWidth >> 1),
				centerY );
	}

	ctxFg.drawImage( hud, hudX, hudY );
}

function playSound( id )
{
	var e = sounds[id];

	if( !e )
		return;

	for( var n = audioChannelsLength; n--; )
	{
		var ac = audioChannels[n];

		if( ac.finished < now )
		{
			ac.finished = now+e.duration*1000;

			var ch = ac.channel;

			if( ch.src != e.src )
			{
				ch.src = e.src;
				ch.load();
			}
			else
				ch.currentTime = 0;

			ch.play();

			break;
		}
	}
}

function random()
{
	// from http://indiegamr.com/generate-repeatable-random-numbers-in-js/
	return (seed = (seed*9301+49297) % 233280)/233280;
}

function createPriests()
{
	var w = mapRight-mapLeft,
		h = mapBottom-mapTop,
		min = Math.min( w, h )*.3;

	for( var n = priestsLength; n--; )
	{
		var a = random()*Math.TAU,
			speed = (.4+random()*.6)*scaleFactor,
			x,
			y;

		do
		{
			x = mapLeft+random()*w,
			y = mapTop+random()*h;
		} while( Math.abs( x-playerX )+Math.abs( y-playerY ) < min );

		priests[n] = {
			x: x,
			y: y,
			vx: Math.cos( a )*speed,
			vy: Math.sin( a )*speed,
			crow: now+now,
			frame: random()*8 | 0,
			lastFrame: 0 };
	}
}

function drawGraves()
{
	var ref = sprites.grave0,
		w = Math.round( ref.width*1.75 ),
		h = Math.round( ref.height*1.5 ),
		mw = Math.round( mapRight-mapLeft ),
		mh = Math.round( mapBottom-mapTop ),
		gw = (mw/w | 0)*w,
		gh = (mh/h | 0)*h,
		px = (mw-gw) >> 1,
		py = (mh-gh) >> 1,
		left = mapLeft+px,
		top = mapTop+py,
		right = left+gw,
		bottom = top+gh,
		n = 0;

	for( var y = top; y < bottom; y += h )
		for( var x = left; x < right; x += w )
		{
			var sprite = sprites["grave"+(++n % 12)];

			ctxBg.drawImage(
				sprite,
				(x+((w-sprite.width) >> 1)) | 0,
				(y+((h-sprite.height) >> 1)) | 0 );
		}
}

function drawYard()
{
	var size = sprites.yardTopLeft.width,
		mw = mapRight-mapLeft,
		mh = mapBottom-mapTop,
		cols = mw/size | 0,
		rows = mh/size | 0,
		map = [],
		o = 0;

	priestsLength = Math.ceil( Math.sqrt( cols*rows ) );

	/*map[o++] = "yardTopLeft";

	for( var x = cols-2; x--; )
		map[o++] = "yardTop";

	map[o++] = "yardTopRight";

	for( var y = rows-2; y--; )
	{
		map[o++] = "yardLeft";

		for( var n = cols-2; n--; )
			map[o++] = "yardMiddle";

		map[o++] = "yardRight";
	}

	map[o++] = "yardBottomLeft";

	for( var x = cols-2; x--; )
		map[o++] = "yardBottom";

	map[o++] = "yardBottomRight";

	o = 0;

	for( var y = mapTop, r = rows; r--; y += size )
		for( var x = mapLeft, c = cols; c--; x += size )
			ctxBg.drawImage(
				sprites[map[o++]],
				x | 0,
				y | 0 );*/
}

function drawGround()
{
	var sprite = sprites.ground,
		w = sprite.width,
		h = sprite.height;

	for( var y = 0; y < height; y += h )
		for( var x = 0; x < width; x += w )
			ctxBg.drawImage(
				sprite,
				x,
				y );
}

function drawBackground()
{
	drawGround();
	drawYard();
	//drawGraves();
}

function updateScore()
{
	putText( ctxHud, ""+scores );
}

function reset()
{
	gameOver = false;

	seed = Math.PI;
	playerX = centerX;
	playerY = centerY;
	playerAlive = true;
	playerFrameLast = playerFrame = 0;
	scoreLast = scores = 0;

	drawBackground();
	createPriests()

	updateScore();
}

function restart()
{
	reset();
	pointerLength = 0;
}

function input()
{
	if( gameOver &&
		pointerLength > 0 )
	{
		restart();
		return;
	}

	for( var n = Math.min( pointerLength, 1 ); n--; )
	{
		playerX = pointerX[n];

		if( playerX < mapLeft )
			playerX = mapLeft;
		else if( playerX > mapRight )
			playerX = mapRight;

		playerY = pointerY[n];

		if( playerY < mapTop )
			playerY = mapTop;
		else if( playerY > mapBottom )
			playerY = mapBottom;
	}
}

function run()
{
	requestAnimFrame( run );

	now = new Date().getTime();
	factor = (now-last)/16;
	var fps = 16/(now-last);
	last = now;

	if( playerAlive &&
		pointerLength &&
		now-scoreLast > 100 )
	{
		++scores;
		scoreLast = now;
		updateScore();
	}

	input();
	draw();

	ctxFg.fillStyle = "#fff";
	ctxFg.fillRect( 0, 0, width*fps | 0, scaleFactor );
}

function setPointers( ev, down )
{
	var e = ev || event;

	if( down < 1 )
	{
		// process remaining touches
		if( pointerLength > 0 &&
			e.touches &&
			(down = e.touches.length) )
			return setPointers( e, down );

		pointerLength = 0;
	}
	else if( e.touches )
	{
		pointerLength = e.touches.length;

		for( var n = 0; n < pointerLength; ++n )
		{
			var t = e.touches[n];

			pointerX[n] = t.pageX;
			pointerY[n] = t.pageY;
		}
	}
	else if( typeof e.clientX !== "undefined" )
	{
		pointerX[0] = e.clientX;
		pointerY[0] = e.clientY;
		pointerLength = 1;
	}
	else if( typeof e.pageX !== "undefined" )
	{
		pointerX[0] = e.pageX;
		pointerY[0] = e.pageY;
		pointerLength = 1;
	}

	if( ratio != 1 )
		for( var n = 0; n < pointerLength; ++n )
		{
			pointerX[n] = pointerX[n]*ratio | 0;
			pointerY[n] = pointerY[n]*ratio | 0;
		}

	// to avoid overscrolling on iOS it's important to
	// catch pointer events
	e.preventDefault();
	return false;
}

function pointerUp( ev )
{
	return setPointers( ev, 0 );
}

function pointerMove( ev )
{
	return setPointers( ev, pointerLength );
}

function pointerDown( ev )
{
	return setPointers( ev, 1 );
}

function scaleSprite( res, rect, w, h )
{
	var c = document.createElement( "canvas" ),
		cx = c.getContext( "2d" );

	c.width = w;
	c.height = h;

	c.centerX = w >> 1;
	c.centerY = h >> 1;

	var offset = rect.y*(atlasWidth << 2)+(rect.x << 2),
		skip = (atlasWidth-rect.w) << 2,
		xs = 0,
		xf = scaleFactor;

	if( res.mirror )
	{
		xf = -xf;
		xs = (scaleFactor*rect.w+xf) | 0;
	}

	for( var ay = rect.h, sy = 0;
		ay--;
		offset += skip, sy += scaleFactor )
	{
		var y = Math.ceil( sy ),
			h = Math.ceil( sy+scaleFactor )-y;

		for( var ax = rect.w, sx = xs;
			ax--;
			sx += xf )
		{
			var r = atlas[offset++],
				g = atlas[offset++],
				b = atlas[offset++],
				a = atlas[offset++];

			if( a == 0 )
				continue;

			var x = Math.ceil( sx );

			cx.fillStyle = 'rgba('+r+','+g+','+b+','+(a/255)+')';
			cx.fillRect(
				x,
				y,
				Math.ceil( sx+Math.abs( xf ) )-x,
				h );
		}
	}

	return c;
}

function scale()
{
	for( var name in resources )
	{
		var res = resources[name],
			rc = res.rect,
			w = Math.max( Math.ceil( rc.w*scaleFactor ), 1 ),
			h = Math.max( Math.ceil( rc.h*scaleFactor ), 1 );

		sprites[name] = scaleSprite( res, rc, w, h );
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	width = w*ratio | 0;
	height = h*ratio | 0;

	bg.width = fg.width = width;
	bg.height = fg.height = height;
	bg.style.width = fg.style.width = w+"px";
	bg.style.height = fg.style.height = h+"px";

	centerX = width >> 1;
	centerY = height >> 1;

	var mapSize = Math.min( width, height );

	scaleFactor = Math.max(
		1,
		mapSize/16/resources.yardTopLeft.rect.w );

	scale();

	hud.width = message.width = width;
	hud.height = message.height =
		resources.f.rect.h*scaleFactor | 0;

	hudX = hudY = scaleFactor << 2;

	mapLeft = (width-mapSize) >> 1;
	mapTop = (height-mapSize) >> 1;
	mapRight = mapLeft+mapSize;
	mapBottom = mapTop+mapSize;

	reset();

	radiusSeen = mapSize*.2 | 0; radiusSeen *= radiusSeen;
	radiusCastOut = sprites.ghost0.width*.5 | 0;
	radiusCollision = radiusCastOut << 4;

	resizing = false;
}

function scheduleResize()
{
	if( resizeTimer )
		clearTimeout( resizeTimer );

	if( running )
		resizing = true;

	resizeTimer = setTimeout( resize, 200 );
}

function start()
{
	var d = document;

	d.onmousedown = pointerDown;
	d.onmousemove = pointerMove;
	d.onmouseup = pointerUp;
	d.onmouseout = pointerUp;

	if( "ontouchstart" in d )
	{
		d.ontouchstart = pointerDown;
		d.ontouchmove = pointerMove;
		d.ontouchend = pointerUp;
		d.ontouchleave = pointerUp;
		d.ontouchcancel = pointerUp;
	}

	last = new Date().getTime();
	running = true;
	run();
}

function createFragments()
{
	var rect = resources.ghost0.rect,
		w2 = rect.w >> 1,
		h2 = rect.h >> 1,
		offset = rect.y*(atlasWidth << 2)+(rect.x << 2),
		skip = (atlasWidth-rect.w) << 2;

	fragmentsLength = 0;

	for( var y = 0, h = rect.h; y < h; ++y, offset += skip )
		for( var x = 0, w = rect.w; x < w; ++x )
		{
			var r = atlas[offset++],
				g = atlas[offset++],
				b = atlas[offset++],
				a = atlas[offset++];

			if( a == 0 )
				continue;

			var cx = x-w2,
				cy = y-h2,
				alpha = Math.atan2( cy, cx ),
				vx = Math.cos( alpha ),
				vy = Math.sin( alpha );

			fragments[fragmentsLength++] = {
				color: 'rgba('+r+','+g+','+b+','+(a/255)+')',
				ox: cx,
				oy: cy,
				ovx: vx,
				ovy: vy,
				spin: Math.random()*Math.TAU };
		}
}

function decompressAtlas()
{
	var c = document.createElement( "canvas" ),
		x = c.getContext( "2d" ),
		w = atlas.width,
		h = atlas.height;

	c.width = w;
	c.height = h;
	x.drawImage( atlas, 0, 0 );

	atlas = x.getImageData( 0, 0, w, h ).data;
	atlasWidth = w;
}

function init()
{
	if( !atlas.complete ||
		new Date().getTime()-last < 500 )
	{
		// give mobile browsers some time to settle
		// their window.innerWidth/Height values, i.e.
		// there may still be the virtual keyboard visible
		setTimeout( init, 500 );
		return;
	}

	decompressAtlas();
	createFragments();

	resize();
	window.onresize = scheduleResize;

	document.body.appendChild( bg );
	document.body.appendChild( fg );

	start();
}

function indexSounds()
{
	var audios = document.getElementsByTagName( "audio" );

	if( !audios ||
		!audios.length )
		return;

	for( var n = audioChannelsLength; n--; )
		audioChannels[n] = {
			channel: new Audio(),
			finished: 0 };

	for( var n = audios.length; n--; )
	{
		var e = audios[n];

		sounds[e.id] = e;
	}
}

function createCanvas()
{
	if( !(bg = document.createElement( "canvas" )) ||
		!(ctxBg = bg.getContext( "2d", { alpha: false } )) ||
		!(fg = document.createElement( "canvas" )) ||
		!(ctxFg = fg.getContext( "2d" )) ||
		!(hud = document.createElement( "canvas" )) ||
		!(ctxHud = hud.getContext( "2d" )) ||
		!(message = document.createElement( "canvas" )) ||
		!(ctxMessage = message.getContext( "2d" )) )
		return false;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctxBg.webkitBackingStorePixelRatio ||
			ctxBg.mozBackingStorePixelRatio ||
			ctxBg.msBackingStorePixelRatio ||
			ctxBg.oBackingStorePixelRatio ||
			ctxBg.backingStorePixelRatio ||
			1);

	return true;
}

function load()
{
	if( !createCanvas() )
	{
		alert( "Sorry, this browser cannot run this game." );
		return;
	}

	indexSounds();

	last = new Date().getTime();

	atlas = new Image();
	atlas.onload = init;
	atlas.src = "data:image/png;base64,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";
}

window.onload = load;

</script>
</body>
</html>
